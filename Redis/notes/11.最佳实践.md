# 最佳实践

---

## key 设计

Redis的key虽然可以自定义，但最好遵循下面的几个最佳实践约定：

1. 遵循基本格式： \[业务名称\]:\[数据名\]:\[id\]
2. 长度不超过44字节
3. 不包含特殊字符

优点： 可读性强、避免key冲突、方便管理、更节省内存(key是string类型，底层编码包含int、embstr和raw三种，embstr在小于44字节使用，采用连续内存空间，内存占用更小)

BigKey通常以key的大小和key中成员的数量来综合判定，例如：

    key本身数据量过大：一个String类型的key，它的值为5MB
    key中的成员数过多： 一个zset类型的key，它的成员数量为10000个
    key中成员的数据量过大： 一个hash类型的key，它的成员数量虽然只有1000个但是这些成员的Value值总大小为100MB

    推荐值： 
        1. 单个key的value小于10KB
        2. 对于集合类型的key，建议元素数量小于1000

BigKey的危害：

1. 网络阻塞

        对BigKey执行读请求时，少量的QPS就可能导致带宽使用率被占满，导致redis实例，乃至所在物理机都变慢
2. 数据倾斜

        BigKey所在的Redis实例内存使用率远超其他实例，无法使数据分片的内存资源达到均衡
3. Redis阻塞
        
        对元素较多的hash、list、zset等做运算会耗时较久，使主线程被阻塞
4. CPU压力

        对BigKey的数据序列化和反序列化会导致CPU的使用率飙升，影响Redis实例和本机其他应用

如何发现BigKey？

1. redis-cli --bigkeys

        利用redis-cli提供的 --bigkeys参数，可以遍历分析所有key，并返回Key的整体统计信息与每个数据的TOP1的big key
2. scan 扫描

        自己编程，利用scan扫描redis中的所有key，利用strlen、hlen等命令判断key的长度（不建议用MEMORY USAGE）
3. 第三方工具

        利用第三方工具，如Redis-Rdb-Tools分析RDB快照文件，全面分析内存使用情况
4. 网络监控

        自定义工具，监控进出Redis的网络数据，超出预警值时主动告警


如何删除BigKey

bigkey内存占用较多，即便是删除这样的key也需要耗费很长时间，导致Redis主线程阻塞，引发一系列问题

1. Redis 3.0及以下版本

        如果是集合类型，则遍历BigKey的元素，先逐个删除子元素，最后删除BigKey
2. Redis 4.0 以后

        Redis在4.0 以后提供了异步删除的命令，unlink

---
最佳实践04

