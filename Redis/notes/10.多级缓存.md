# 多级缓存

---

# Caffeine

基于java8开发的，提供了近乎最佳命中率的本地存储库

[Caffeine](https://github.com/ben-manes/caffeine)

三种缓存驱逐策略，防止缓存填满：
1. 基于容量： 设置容量的上限
2. 基于时间： 设置缓存的有效时间
3. 基于引用： 设置缓存为软引用或弱引用，利用GC来回收缓存数据。性能较差，不建议使用。

---

## Nginx lua

一些lua的语法：

| 数据类型     | 描述                                                                                      |
|----------|-----------------------------------------------------------------------------------------|
| nil      | 最简单，只有nil值属于该类型，表示一个无效值，作为bool表达式为false                                                 |
| boolean  | 包含两个值 true 和 false                                                                      |
| number   | 表示双精度类型的实浮点数                                                                            |
| string   | 字符串， 由一对双引号或者单引号来表示                                                                     |
| function | 由C或者LUA编写的函数                                                                            |
| table    | Lua中的表，其实是一个”关联数组“，数组的索引可以是数字、字符串或者表类型。在lua里，table的创建是通过“构造表达式”来完成，最简单的构造表达式{},用来创建一个空表 |

可以使用 type(变量) 来判断变量的数据类型

声明变量：  local 变量名 = 变量值   （不需要指定数据类型）

访问table中的数据： 
    
    带key的 ： 直接点  local a = {name='zhangsan', age=25} ==>  a.name
    不带key的： 下标    local b = {'a', 'b', 'c' }   =>  b[1] 就是 a // 下标从1开始

遍历整个table

    for index,value in ipairs(table) do
        xxxxxx
    end

拼接字符串用  ..  而不是  +    ==>  a..b => ab

函数：
    
    function 函数名 (参数1, 参数2, 参数3)
        -- 函数体
        return 返回值
    end


条件判断：

    if(布尔表达式)
    then
        -- true 逻辑
    else
        -- false 逻辑
    end

    布尔表达式的连接用英文单词   and or  not

---

## OpenResty

[OpenResty](https://openresty.org/cn/)

一些配置示例

1. nginx.conf 中的 http 块添加对OpenResty的lua支持

        # 加载lua模块
        lua_package_path "/your/lua/script/path/?.lua;;";
        # 加载c模块
        lua_package_cpath "/your/lua/c/script/path/?.so;;";

2. 配置local 支持lua解析

        location /xxx  {
            #默认响应类型
            default_type application/json;
            #响应数据由 xxx.lua这个文件决定
            coutent_by_lua_file xxx.lua;
        }

3. 一些请求参数的获取示例

| 参数格式     | 参数示例          | 解析代码                                                                              |
|----------|---------------|-----------------------------------------------------------------------------------|
| 路径占位符    | /item/1001    | 当请求匹配为  location /item/(\d+) 时， 使用 local id = ngx.var\[1\]                        |
| 请求头      | id: 1001      | local headers = ngx.req.get_headers()                                             |
| Get请求参数  | ?id=1001      | local getParams = ngx.req.get_uri_args()                                          |
| Post表单参数 | id=1001       | 请求体： ngx.req.read_body(), 表单参数table： local postParams = ngx.req.get_post_args()   |
| JSON参数   | {"id": 1001}  | 请求体： ngx.req.read_body(), body中的json参数： local jsonBody = ngx.req.get+body_data()  |



