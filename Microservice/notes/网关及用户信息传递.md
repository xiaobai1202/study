# 网关

---

网关就是网络的关口，负责请求的路由、转发、身份校验。

网关路由对应的java类型时RouteDefinition，其中常见的属性有：

1. id： 路由唯一标识
2. uri： 路由目标地址
3. predicates： 路由断言，判断请求是否符合当前路由。
4. filters: 路由过滤器，对请求或响应做特殊处理。

spring提供了12种路由断言：

| 名称                     | 说明              | 示例                                                                                                      |
|------------------------|-----------------|---------------------------------------------------------------------------------------------------------|
| After                  | 是某个时间点之后的请求     | - After=2025-12-16T21:28:32.789+08:00\[Asia/Shanghai\]                                                  |
| Before                 | 是某个是简单之前的请求     | - Before=2025-12-16T21:28:32.789+08:00\[Asia/Shanghai\]                                                 |
| Between                | 是某两个时间点之间的请求    | - Between=2025-12-16T21:28:32.789+08:00\[Asia/Shanghai\],2035-12-31T23:59:59.999+08:00\[Asia/Shanghai\] |
| Cookie                 | 请求头必须包含某些cookie | - Cookie=chocolate,ch.p                                                                                 |
| Header                 | 请求头必须包含某些header | - Header=X-Request-Id                                                                                   |
| Host                   | 请求必须是访问某个host   | - Host=\**.some-host.com,\**.another.org                                                                |
| Method                 | 请求方式必须使指定方式     | - Method=GET,POST                                                                                       |
| Path                   | 请求路径必须符合指定规则    | - Path=/red/{segment},/blue/**                                                                          |
| Query                  | 请求参数必须包含指定参数    | - Query=name                                                                                            |
| RemoteAddr             | 请求者的ip必须是指定范围   | - RemoteAddr=192.168.1.1/24                                                                             |
| Weight                 | 权重处理            | - Weight=group1,2                                                                                       |
| XForwarded Remote Addr | 基于请求的来源ip做判断    | - XForwardedRemoteAddr=172.24.10.0/24                                                                   |


Spring种提供了33种过滤器，这里只是举例几个：

| 名称                   | 说明             | 示例                                            |
|----------------------|----------------|-----------------------------------------------|
| AddRequestHeader     | 给当前请求加一个请求头    | AddRequestHeader=headerName，headerValue       |
| RemoveRequestHeader  | 移除请求中的一个请求头    | RemoveRequestHeader=headerName                |
| AddResponseHeader    | 给响应种添加一个响应头    | AddResponseHeader=headerName，headerValue      |
| RemoveResponseHeader | 从响应结果中移除一个响应头  | RemoveResponseHeader=headerName               |
| RewritePath          | 请求路径重写         | RewritePath=/red/?(?<segment>.*),/$\{segment} |
| StripPrefix          | 去除请求路径种的前N段前缀  | StripPrefix=1 （则路径/a/b转发时就变成了/b）              |


基于网关做用户鉴权：

    如何在网关转发之前做校验： 自定义过滤器
    网关如何将用户信息传递给微服务： 通过请求头信息传递
    微服务之间如何传递用户信息： 保存用户到请求头（特殊处理）

网关过滤器有两种：

    GatewayFilter： 路由过滤器，作用于任意指定的路由；默认不生效，要配置到路由后生效
    GlobalFilter： 全局过滤器，作用范围是所有路由；声明后自动生效。

微服务之间相互调用传递用户信息

    OpenFeign： 提供了一个拦截器接口，所有由OpenFeign发起的请求都会先调用拦截器处理请求，可以将用户信息通过
    拦截器注入到请求中。

微服务登录解决方案全流程

1. 网关：定义全局拦截器，进行登录校验，将用户信息保存到请求头
2. 微服务种通过全局拦截器获取网关的请求头中的用户信息，保存到ThreadLocal种
3. 微服务之间的调用通过OpenFeign，通过OpenFeign的拦截器将当前服务的ThreadLocal中的用户信息通过拦截器发送给其他服务


