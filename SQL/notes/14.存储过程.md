# 存储过程

---

存储过程是事先经过编译并存储在数据库中的一段SQL语句的集合，调用存储过程可以简化应用开发人员的很多工作，减少数据在数据库和应用服务之间的传输，对于提高数据处理的效果是有好处的。
存储过程思想上很简单，就是数据库SQL语言层面的代码封装与重用。

**tip: 命令行中可以通过 delimiter xxx 来指定sql语句的结束符为xxx**

## 基本语法

1. 创建

        CREATE PROCEDURE 存储过程名([参数列表])
        BEGIN
            -- SQL 集合
        END;
2. 调用

        CALL 名称([参数]);
3. 查看
        
        SELECT * FROM INFORMATION_SCHEMA.ROUTINES WHERE ROUTINE_SCHEMA = 'XXX' -- 查询指定数据库的存储过程及状态信息
        SHOW CREATE PROCEDURE 存储过程名; -- 查询某个存储过程定义
4. 删除

        DROP PROCEDURE [IF EXISTS] 存储过程名;

---

## 系统变量

系统变量是MYSQL服务器提供的，不是用户定义的，属于服务器层面。分为全局变量（GLOBAL）、会话变量（SESSION）,如果不指定默认是SESSION

1. 查看系统变量
        
        SHOW [SESSION|GLOBAL].VARIABLES; --所有系统变量
        SHOW [SESSION|GLOBAL].VARIABLES LIKE '...' --通过like模糊匹配查找变量
        SELECT @@[SESSION|GLOBAL].系统变量名; --查看指定变量的值
2. 设置系统变量

        SET [SESSION|GLOBAL] 系统变量名=值;
        SET @@[SESSION|GLOBAL] 系统变量名=值;

## 用户自定义变量

用户自定义变量是用户根据需要自己定义的变量，用户变量不用提前声明，在用的时候直接用 @变量名 使用就可以。其作用域为当前连接

1. 赋值

        SET @var_name = expr,[@var_name=expr]...
        SET @var_name :=expr
        SELECT @var_name :=expr
        SELECT 字段名 INTO @var_name FROM 表名;

2. 使用

        SELECT @var_name;

用户自定义变量不用声明，直接赋值即可，若没有声明或者赋值 则为null  不会报错

##  局部变量

局部变量是根据需要定义在局部生效的变量，访问之前需要使用DECLARE声明，可用作存储过程内的局部变量和输入参数，局部变量的范围是在其声明的begin ...end 块内。

1. 声明

        DECLARE 变量名 变量类型 [DEFAULT ...];

2. 赋值

        SET 变量名 = 值
        SET 变量名 := 值
        SELECT 字段名 INTO 变量名 FROM 表名...;

##  if 条件判断

1. 语法

        IF 条件1 THEN
            ...
        ELSEIF 条件2 THEN            -- 可选
            ...
        ELSE                         -- 可选
            ...
        END IF;

## 参数

| 类型     | 含义                     | 备注 |
|--------|------------------------|----|
| IN     | 该类参数作为输入，也就是需要调用时传入值   | 默认 |
| OUT    | 该类参数作为输出，也就是该参数可以作为返回值 |    |
| INOUT  | 既可以作为输入参数也可以作为输出参数     |    |

用法

        CREATE PROCEDURE 存储过程名([IN/OUT/INOUT 参数名 参数类型])
        BEGIN
            ...
        END;

## case 语句

语法1

        CASE case_value
            WHEN when_value1 THEN ....
            [WHEN when values2 THEN ....]
            ...
            [ELSE ...]
        END CASE;

语法2

        CASE
            WHEN condition1 THEN ....
            [WHEN condition2 THEN ....]
            [ELSE ....]
        END CASE;

## 循环

while语法(满足条件执行)：

        WHILE 条件 DO
            sql 逻辑
        END WHILE;

repeat 语法(执行到满足条件后退出)：
    
        REPEAT
            SQL逻辑
            UNTIL 条件
        END REPEAT;

loop:

    loop实现简单的循环，如果不在sql逻辑中增加退出循环的条件，可以用其来实现简单的死循环。loop可以配合以下两个语句使用：
    
    LEAVE: 配合循环使用，退出循环
    
    ITERATE: 必须使用在循环中，作用是跳过当前循环剩下的语句，重新开始下一次循环。

    语法：
        
        [bengin_label:] LOOP
            SQL逻辑...
        END LOOP [end_label];

        LEAVE label 退出标定的循环体
        ITERATE label 直接进入下一次循环

    eg:
        -- 计算 1-n 累加
        create procedure p(in n int)
        begin
            declare total int default 0;
            sum: loop
                if n <= 0 then 
                    leave sum;
                end if;
                set total = total + n;
                set n = n - 1;
            end loop sum;
            select total;
        end;

        -- 计算 1-n 偶数累加
        create procedure p2(in n int)
        begin
            declare total int default 0;
            sum: loop
                if n <= 0 then 
                    leave sum;
                elseif n % 2 = 1 then
                    set n = n - 1;
                    iterate sum;
                end if;
                set total = total + n;
                set n = n - 1;
            end loop sum;
            select total;
        end;


## 游标

56-游标--cursor




